<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>SHT30 æ¸©æ¹¿åº¦ç›‘æŽ§</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      text-align: center;
    }
    canvas {
      max-width: 900px;
      margin: 20px auto;
    }
    .value {
      font-size: 20px;
      margin: 10px;
    }
  </style>
</head>

<body>

<h2>ESP32 Â· SHT30 å®žæ—¶ç›‘æŽ§</h2>

<div class="value">
  ðŸŒ¡ æ¸©åº¦ï¼š<span id="temp">--</span> Â°Cã€€
  ðŸ’§ æ¹¿åº¦ï¼š<span id="humi">--</span> %
</div>

<canvas id="chart"></canvas>

<script>
  // ===== ä¿®æ”¹ä¸ºä½  ESP32 çš„ IP =====
  const ESP32_IP = "ws://wss://kinley-nonevolutional-orthopedically.ngrok.io//";   // â† æ”¹è¿™é‡Œ

  const tempSpan = document.getElementById("temp");
  const humiSpan = document.getElementById("humi");

  const ctx = document.getElementById("chart").getContext("2d");

  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: "æ¸©åº¦ (Â°C)",
          borderColor: "red",
          data: [],
          tension: 0.3
        },
        {
          label: "æ¹¿åº¦ (%)",
          borderColor: "cyan",
          data: [],
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          ticks: { color: "#aaa" }
        },
        y: {
          ticks: { color: "#aaa" }
        }
      }
    }
  });

  // ===== WebSocket =====
  const ws = new WebSocket(ESP32_IP);

  ws.onopen = () => {
    console.log("WebSocket å·²è¿žæŽ¥");
  };

  ws.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);
      const t = data.temperature;
      const h = data.humidity;

      const time = new Date().toLocaleTimeString();

      tempSpan.textContent = t.toFixed(1);
      humiSpan.textContent = h.toFixed(1);

      chart.data.labels.push(time);
      chart.data.datasets[0].data.push(t);
      chart.data.datasets[1].data.push(h);

      // åªä¿ç•™æœ€è¿‘ 60 ä¸ªç‚¹
      if (chart.data.labels.length > 60) {
        chart.data.labels.shift();
        chart.data.datasets.forEach(ds => ds.data.shift());
      }

      chart.update();
    } catch (e) {
      console.error("æ•°æ®è§£æžå¤±è´¥", e);
    }
  };

  ws.onerror = (err) => {
    console.error("WebSocket é”™è¯¯", err);
  };
</script>

</body>
</html>
