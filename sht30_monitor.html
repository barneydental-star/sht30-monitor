<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SHT30 温湿度监控</title>
<style>
  body { font-family: Arial; text-align:center; margin:0; background:#111; color:#fff; }
  canvas { background:#222; display:block; margin:20px auto; }
  h1 { margin-top:20px; }
  #status { margin-top:10px; font-size:16px; }
</style>
</head>
<body>
<h1>SHT30 温湿度曲线</h1>
<canvas id="chart" width="600" height="300"></canvas>
<p id="status">正在连接 ESP32...</p>

<!-- Chart.js 库 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ===== WebSocket 设置 ===== */
const ESP32_IP = "wss://kinley-nonevolutional-orthopedically.ngrok.io/"; // ← 填入你 ngrok 显示的 WSS 地址

/* ===== 数据存储 ===== */
let ws = new WebSocket(ESP32_IP);
let tempData = [];
let humiData = [];
let labels = [];

/* ===== Chart.js 初始化 ===== */
const ctx = document.getElementById('chart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [
            { label: '温度 (℃)', data: tempData, borderColor: 'red', fill:false },
            { label: '湿度 (%)', data: humiData, borderColor: 'blue', fill:false }
        ]
    },
    options: {
        animation:false,
        scales: {
            y: {
                beginAtZero:true,
                suggestedMax:100
            }
        }
    }
});

/* ===== WebSocket 回调 ===== */
ws.onopen = () => {
    document.getElementById('status').innerText = '已连接 ESP32';
};

ws.onmessage = (event) => {
    try {
        let obj = JSON.parse(event.data);
        let now = new Date().toLocaleTimeString();
        labels.push(now);
        tempData.push(obj.temperature);
        humiData.push(obj.humidity);

        // 保留最近 30 条数据
        if (labels.length > 30) {
            labels.shift();
            tempData.shift();
            humiData.shift();
        }
        chart.update();
    } catch(e) {
        console.error('解析 WebSocket 数据失败:', e);
    }
};

ws.onerror = () => {
    document.getElementById('status').innerText = 'WebSocket 连接失败';
};

ws.onclose = () => {
    document.getElementById('status').innerText = 'WebSocket 已关闭';
};
</script>
</body>
</html>
